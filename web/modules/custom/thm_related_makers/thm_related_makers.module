<?php

/**
 * @file
 * Contains thm_related_makers.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\search_api\Entity\Index;
use Drupal\node\NodeInterface;
use Drupal\file\Entity\File;
use Drupal\taxonomy\Entity\Term;

/**
 * Implements hook_help().
 */
function thm_related_makers_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the thm_related_makers module.
    case 'help.page.thm_related_makers':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Module for retrieval and display of people related to a specific HistoryMaker') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function thm_related_makers_theme() {
  return [
    'thm_related_makers' => [
      'variables' => [ 'data' => null ],
    ],
  ];
}

/**
 * Implements hook_preprocess_HOOK().
 */
function thm_related_makers_preprocess_block(&$variables) {
  $variables['#cache']['max-age'] = 0;
}


/**
 * Retrieves the node in current display context (page|view|block).
 * Returns false if node id isn't found.
 *
 * @return int|bool
 */
function thm_related_makers_get_current_nid() {
  $node = \Drupal::routeMatch()->getParameter('node');

  if ($node instanceof NodeInterface) {
    return $node->id();
  } else {
    return false;
  }
}

function thm_related_makers_get_image_url($fid) {
  return file_url_transform_relative(
    file_create_url(File::load($fid)->getFileUri()));
}

function thm_related_makers_get_terms($tidList) {

  return array_map(function($tid) {
    return Term::load($tid)->getName();
  }, $tidList);
}

function thm_related_makers_parse_results($results) {

  return array_map(function($item) {
    /** @var Drupal\search_api\Item\ItemInterface $item */
    return [
      'title' => @$item->getField('title')->getValues()[0],
      'first_name' => @$item->getField('field_first_name')->getValues()[0],
      'last_name' => @$item->getField('field_last_name')->getValues()[0],
      'bio_image' =>
        @$item->getField('field_bio_image')->getValues()[0],
      'body' => @$item->getField('body')->getValues()[0],
      'maker_types' => thm_related_makers_get_terms(
        @$item->getField('field_maker_category')->getValues())
    ];
  }, $results);
}

function get_test_data() {
  return [
    [
      'title' => 'John Atchison',
      'first_name' => 'John',
      'last_name' => 'Atchison',
      'bio_image' => '/sites/default/files/Atchison_John_wm.png',
      'maker_types' => [
        'StyleMakers'
      ]
    ],
    [
      'title' => 'Na\'im Akbar',
      'first_name' => 'Na\'im',
      'last_name' => 'Akbar',
      'bio_image' => '/sites/default/files/Akbar_Naim_wm.png',
      'maker_types' => [
        'EducationMakers'
      ]
    ],
    [
      'title' => 'The Honorable John Allen',
      'first_name' => 'John',
      'last_name' => 'Allen',
      'bio_image' => '/sites/default/files/Allen_John_wm.png',
      'maker_types' => [
        'LawMakers'
      ]
    ]
  ];
}

/**
 * Performs the search.
 *
 */
function thm_related_makers_perform_search($test = false) {

  if ($test) {
    return [ 'count' => 3, 'data' => get_test_data() ];
  }

  $index = Index::load('biography_index');

  /** @var Drupal\search_api\Query\QueryInterface $query */
  $query = $index->query();
  $nid   = thm_related_makers_get_current_nid();

  $parseMode = \Drupal::service('plugin.manager.search_api.parse_mode')
    ->createInstance('direct')
    ->setConjunction('OR');

  $query->setParseMode($parseMode);

  $query->keys('The Honorable John Allen');

  $query->setFulltextFields([
    'body', 'field_first_name', 'field_last_name', 'title'
  ]);

  $query->range(0, 5);

  $results = $query->execute();

  return [
    'count' => $results->getResultCount(),
    'data' => array_values(thm_related_makers_parse_results(
      $results->getResultItems()
    ))
  ];
}
