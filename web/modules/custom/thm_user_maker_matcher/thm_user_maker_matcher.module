<?php

/**
 * @file
 * Contains thm_user_maker_matcher.module.
 */

use Drupal\Core\Routing\RouteMatchInterface as RMI;
use Drupal\Core\Form\FormStateInterface as FSI;
use Drupal\webform\WebformSubmissionInterface as WSI;

/**
 * Implements hook_help().
 */
function thm_user_maker_matcher_help($route_name, RMI $route_match) {
  switch ($route_name) {
    // Main module help for the thm_user_maker_matcher module.
    case 'help.page.thm_user_maker_matcher':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Maps common experiences and attributes between users and makers.') . '</p>';
      return $output;

    default:
  }
}

function _getWebformSessionKey() {
  $webformSessionKeyBase = 'maker_matcher_uid_';
  return $webformSessionKeyBase . \Drupal::currentUser()->id();
}

function _getSession() {
  return \Drupal::request()->getSession();
}

/**
 * Implements hook_theme().
 */
function thm_user_maker_matcher_theme() {
  return [
    'thm_user_maker_matcher' => [
      'variables' => [
        'data' => null,
        'result_count' => null,
        'base_url' => \Drupal::request()->getHost()
      ]
    ],
  ];
}

function thm_user_maker_matcher_webform_submission_prepare_form(WSI $webformSubmission, $op, FSI $formState) {
  if ($data = _getSession()->get(_getWebformSessionKey())) {
    $webformSubmission->setElementData('matches', [ '#markup' => $data ]);
    $formState->set('current_page', 'webform_confirmation');
    $formState->setRebuild();
  }
}

function _elementExists(array $vs, string $elementName) {
  return array_key_exists('element', $vs) &&
    array_key_exists('#id', $vs['element']) &&
    $vs['element']['#id'] === $elementName;
}

